@model IEnumerable<Seatly1.Controllers.CollectionsController.CollectionViewModel>

@{
    ViewData["Title"] = "Collections";
}

<h2>收藏清單</h2>

@if (Model.Any())
{
    <div class="row">
        @foreach (var item in Model)
        {
            <div class="col-md-6">
                <div class="card mb-4 d-flex flex-row">
                    <div class="card-img-left " style="width:200px">
                        @if (item.ActivityPhoto != null)
                        {
                            var base64Image = Convert.ToBase64String(item.ActivityPhoto);
                            var imageSrc = $"data:image;base64,{base64Image}";
                            <img class="img-fluid rounded-3 h-100" src="@imageSrc" alt="ActivityPhoto" />
                        }
                        else
                        {
                            <img src="~/images/noimage.jpg" />
                        }
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">@item.ActivityName</h5>
                        <p class="card-text">活動 ID: @item.ActivityId</p>
                        <div><span class="text-warning me-2">📍</span><span class="text-primary">@item.Location</span></div>
                        @{
                            string formattedStartTime = string.Format("{0:yyyy-MM-dd}", item.StartTime);
                            string formattedEndTime = string.Format("{0:yyyy-MM-dd}", item.EndTime);
                        }
                        <span class="text-1000 fw-bold">@formattedStartTime ~ @formattedEndTime</span>
                        <p>
                            @for (int k = 1; k <= 5; k++)
                            {
                                var tagName = "HashTag" + k;
                                var tagValue = item.GetType().GetProperty(tagName)?.GetValue(item, null)?.ToString();
                                if (!string.IsNullOrEmpty(tagValue) && tagValue != "HOT")
                                {
                                    <span>#<span class="hash-tag">@tagValue</span></span>
                                }
                            }
                        </p>
                        <a href="@Url.Action("UsersView", "NotificationRecord", new { id = item.ActivityId })" class="btn btn-primary">查看詳情</a>
                        <button class="btn btn-danger" onclick="removeFromCollection(@item.ActivityId)">移除收藏</button>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <p>沒有收藏項目。</p>
}

@section Scripts{
    @Html.AntiForgeryToken()
<script>
    async function removeFromCollection(activityId) {
        if (confirm('確定要移除該收藏項目嗎？')) {
            try {
                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                    const payload = { activityId: activityId };

                    console.log('Payload:', payload);

                const response = await fetch('/Collections/RemoveFromCollection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (data.success) {
                    alert('收藏項目已移除');
                    location.reload(); // 刷新页面以更新视图
                } else {
                    alert('移除收藏項目失敗：' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('移除收藏項目失敗，請稍後再試！');
            }
        }
    }
</script>
}