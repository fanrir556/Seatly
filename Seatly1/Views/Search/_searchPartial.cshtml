@model IEnumerable<NotificationRecord>

@* @{
    Layout =   "/Views/Shared/_Layout.cshtml";
} *@

<style>


.love-icon {
    cursor: pointer;
    transition: transform 0.2s;
}

.love-icon:hover {
    transform: scale(1.2);
}

</style>


@if (Model != null && Model.Any())
{
   
@* 卡片內容 *@
    <div>
        <ul id="activityList" >
            @foreach (var activity in Model)
            {
                <div  class="card mb-3 position-relative">
                    <div class="row g-0">
                        <div class="col-md-4">
                            @{
                                var base64Image = Convert.ToBase64String(activity.ActivityPhoto);
                                var imageSrc = $"data:image;base64,{base64Image}";
                            }
                            <img src="@imageSrc" alt="Activity Photo" class="img-fluid mb-2 mt-2 ms-2 w-75"  />
                        </div>
                        <div class="col-md-8">
                            <div class="card-body">
                                <h3 class="card-title fs-3">活動名稱: @activity.ActivityName</h3>
                                <p class="card-text">活動代碼: @activity.ActivityId</p>
                                <p class="card-text">開始時間: @activity.StartTime</p>
                                <p class="card-text">結束時間: @activity.EndTime</p>
                                
                                <p class="card-text ">活動地點: <span class="location">@activity.Location</span></p>
                                <p class="card-text">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        var tagName = "HashTag" + i;
                                        var tagValue = activity.GetType().GetProperty(tagName)?.GetValue(activity, null)?.ToString();
                                        if (!string.IsNullOrEmpty(tagValue))
                                        {
                                            <span>#<span class="hash-tag">@tagValue</span></span>
                                        }
                                    }
                                </p>

                                <span class="position-absolute top-0 end-0 m-3">
                                    <a :class="isCollected(@activity.ActivityId) ? 'text-danger' : 'text-secondary'" class="love-icon" @@click="toggleCollection({ activityId: @activity.ActivityId })">
                                        {{ isCollected(@activity.ActivityId) ? '❤️已收藏' : '🤍加入收藏' }}
                                    </a>
                                </span>
                              
                                

                                <form asp-action="UsersView" asp-controller="NotificationRecord" asp-route-id="@activity.ActivityId">
                                    <button type="submit" class="btn btn-primary position-absolute bottom-0 end-0 mb-2 me-2" @@click="userview"
                                            btn-Aid="@activity.ActivityId">查看活動</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <br />
            }
        </ul>
    </div>
}

else
{
    <p>查無此活動</p>
}


<script>
  

    $(function () {
        var isSearching = sessionStorage.getItem("isSearching");
        if (isSearching == "true") {
            var hashtags = [];
            $(".hash-tag").each(function () {
                var tag = $(this).text()
                hashtags.push(`${tag}`)
            });
            
            var locations = [];
            $('.location').each(function () {
                var location = $(this).text()
                locations.push(`${location}`)
            })

            console.log(hashtags)
            console.log(locations)

            var filterData = {
                hashtags: hashtags,
                locations: locations
            };


            fetch(`@Url.Action("sideFilterPartial", "Search")`, {
                method: "POST",
                body: JSON.stringify(filterData),
                headers: { 'Content-type': 'application/json' }
            }).then(function (response) {
                return response.text();
            }).then(function (data) {
                $("#sideFilterContainer").html(data);
            }).catch(function (err) {

            });
            sessionStorage.removeItem("isSearching");
        }

    });

    // @* 加入收藏 *@

    var vueApp = {
        data() {
            return {
                userCollections: [],
                isLoggedIn: sessionStorage.getItem('userLogin') === 'true', // 檢查用戶是否登錄
            }
        },
        mounted() {
            if (this.isLoggedIn) {
                this.restoreLocalStorage(); // 恢復收藏狀態
                this.getUserCollections();
            }
            // console.log('Mounted, isLoggedIn:', this.isLoggedIn);
            // console.log('Mounted, userCollections:', this.userCollections);
        },
        methods: {
            // 收藏相關判斷 -start-
            async getUserCollections() {
                if (this.isLoggedIn) {
                    const response = await fetch('/Collections/GetUserCollections');
                    console.log(response)
                    const data = await response.json();
                    console.log(data)


                    console.log('User collections:', this.userCollections);
                }
            },
            async toggleCollection(activity) {
                if (!this.isLoggedIn) {
                    // 檢查用戶是否登入
                    alert('請先登入會員！');
                    return;
                }
                const index = this.userCollections.indexOf(activity.activityId);
                if (index > -1) {
                    // 移除收藏
                    await this.removeFromCollection(activity.activityId);
                } else {
                    // 加入收藏
                    await this.addToCollection(activity.activityId);
                }

                // 更新本地存儲的收藏狀態
                this.updateLocalStorage();
            },
            async addToCollection(activityId) {
                console.log('Trying to add to collection:', activityId); // Debug: log activityId
                const response = await fetch(`/Collections/AddToCollection?activityId=${activityId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                console.log('Add to collection response:', result); // Debug: log server response
                if (result.success) {
                    this.userCollections.push(activityId);
                } else {
                    alert(result.message || '熱門項收藏失敗');
                }
            },
            async removeFromCollection(activityId) {
                const response = await fetch('/Collections/RemoveFromCollection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ activityId: activityId })
                });
                const result = await response.json();
                if (result.success) {
                    const index = this.userCollections.indexOf(activityId);
                    if (index > -1) {
                        this.userCollections.splice(index, 1);
                    }
                } else {
                    alert(result.error || '移除收藏失敗');
                }
            },
            isCollected(activityId) {
                return this.userCollections.includes(activityId);
            },

            updateLocalStorage() {
                localStorage.setItem('userCollections', JSON.stringify(this.userCollections));
            },
            restoreLocalStorage() {
                const storedCollections = localStorage.getItem('userCollections');
                if (storedCollections) {
                    this.userCollections = JSON.parse(storedCollections);
                }
            },
            // 收藏相關判斷 -end-

            //資訊頁面
            userview: function () 
            {
                const btn = event.target;
                // 從按鈕元素中取得自定義屬性"btn-Aid"
                const btnAid = btn.getAttribute("btn-Aid");
                // 將btnAid值存入sessionStorage
                sessionStorage.setItem("ActID", btnAid);
                // 選擇性地顯示alert
                // alert(btnAid);
            }
        },
    }
    Vue.createApp(vueApp).mount("#activityList");
    
    
   
</script>
